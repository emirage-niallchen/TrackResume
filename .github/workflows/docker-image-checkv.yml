name: Build and Push Docker Image (Simple)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      IMAGE_NAME: niallchen/track-resume

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Check version from version.txt
      id: version-check
      run: |
        if [ -f "version.txt" ]; then
          VERSION=$(cat version.txt | tr -d '[:space:]')
          echo "Found version: $VERSION"
          if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "VERSION=" >> $GITHUB_ENV
          fi
        else
          echo "VERSION=" >> $GITHUB_ENV
        fi

    - name: Login to DockerHub
      if: env.VERSION != ''
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Check if image exists (using docker manifest)
      if: env.VERSION != ''
      id: check_image
      continue-on-error: true  # 允许失败，如果镜像不存在
      run: |
        echo "Checking if image exists..."
        # 尝试拉取镜像的manifest，如果成功则镜像存在
        docker manifest inspect ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
        echo "IMAGE_EXISTS=true" >> $GITHUB_ENV
        echo "✅ Image already exists on Docker Hub"

    - name: Build Docker image (if not exists)
      if: env.VERSION != '' && env.IMAGE_EXISTS != 'true'
      run: |
        echo "Building Docker image..."
        docker build -t ${{ env.IMAGE_NAME }}:${{ env.VERSION }} -t ${{ env.IMAGE_NAME }}:latest .
        echo "✅ Docker image built"

    - name: Push Docker image (if not exists)
      if: env.VERSION != '' && env.IMAGE_EXISTS != 'true'
      run: |
        echo "Pushing Docker image..."
        docker push ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
        docker push ${{ env.IMAGE_NAME }}:latest
        echo "✅ Docker image pushed"