#!/usr/bin/env node

/**
 * MySQL to PostgreSQL SQL Converter
 * 将 MySQL SQL 导出文件转换为 PostgreSQL 格式
 */

const fs = require('fs');
const path = require('path');

const inputFile = process.argv[2] || path.join(__dirname, '../cv_dev.sql');
const outputFile = process.argv[3] || path.join(__dirname, '../cv_dev_postgresql.sql');

console.log(`Converting ${inputFile} to PostgreSQL format...`);
console.log(`Output file: ${outputFile}`);

let content = fs.readFileSync(inputFile, 'utf8');

// 1. 移除反引号，替换为双引号（PostgreSQL 使用双引号）
content = content.replace(/`/g, '"');

// 2. 移除 MySQL 特定的表选项
content = content.replace(/ENGINE\s*=\s*InnoDB[^;]*/gi, '');
content = content.replace(/DEFAULT\s+CHARSET\s*=\s*[^\s;]+/gi, '');
content = content.replace(/COLLATE\s*=\s*[^\s;]+/gi, '');
content = content.replace(/AUTO_INCREMENT\s*=\s*\d+/gi, '');

// 3. 移除 AUTO_INCREMENT 列属性（PostgreSQL 使用 SERIAL 或序列）
content = content.replace(/AUTO_INCREMENT/gi, '');

// 4. 转换数据类型
// DATETIME -> TIMESTAMP
content = content.replace(/\bDATETIME\b/gi, 'TIMESTAMP');
// TINYINT -> SMALLINT 或 BOOLEAN（根据上下文，这里保持 SMALLINT）
content = content.replace(/\bTINYINT\(1\)\b/gi, 'BOOLEAN');
content = content.replace(/\bTINYINT\b/gi, 'SMALLINT');
// LONGTEXT -> TEXT
content = content.replace(/\bLONGTEXT\b/gi, 'TEXT');
// MEDIUMTEXT -> TEXT
content = content.replace(/\bMEDIUMTEXT\b/gi, 'TEXT');

// 5. 移除 MySQL 特定的索引类型
content = content.replace(/USING\s+BTREE/gi, '');
content = content.replace(/USING\s+HASH/gi, '');

// 6. 转换默认值
// MySQL 的 CURRENT_TIMESTAMP -> PostgreSQL 的 NOW()
content = content.replace(/DEFAULT\s+CURRENT_TIMESTAMP/gi, "DEFAULT NOW()");
content = content.replace(/ON\s+UPDATE\s+CURRENT_TIMESTAMP/gi, '');

// 7. 处理字符串转义
// MySQL 使用反斜杠转义，PostgreSQL 使用单引号转义
// 但这里需要小心，因为可能影响字符串内容
// 先处理常见的转义序列
content = content.replace(/\\'/g, "''"); // MySQL \' -> PostgreSQL ''

// 8. 移除 MySQL 特定的注释语法（如果存在）
// 保持标准 SQL 注释

// 9. 处理 INSERT 语句中的值
// PostgreSQL 对布尔值使用 true/false 而不是 1/0
// 但这里需要根据列类型判断，暂时保持原样，后续手动调整

// 10. 确保所有表名和列名使用小写（PostgreSQL 推荐）
// 但为了保持兼容性，这里保持原样

// 11. 移除 MySQL 特定的锁表语句
content = content.replace(/LOCK\s+TABLES[^;]*;/gi, '');
content = content.replace(/UNLOCK\s+TABLES[^;]*;/gi, '');

// 12. 移除 MySQL 特定的设置
content = content.replace(/SET\s+[^;]*;/gi, function(match) {
  // 保留一些有用的设置，移除 MySQL 特定的
  if (match.includes('NAMES') || match.includes('CHARACTER_SET')) {
    return '';
  }
  return match;
});

// 13. 处理主键自增（如果使用 AUTO_INCREMENT）
// 需要在 CREATE TABLE 后添加序列创建语句
// 这里先移除，后续手动处理或使用 Prisma 迁移

// 14. 确保每个语句以分号结尾
// 移除多余的分号

// 15. 添加 PostgreSQL 特定的设置
const pgHeader = `-- PostgreSQL converted from MySQL
-- Generated by mysql-to-postgresql.js
-- 
-- Note: You may need to manually adjust:
-- 1. AUTO_INCREMENT columns (use SERIAL or sequences)
-- 2. Boolean values in INSERT statements (1 -> true, 0 -> false)
-- 3. Character set and collation settings
-- 4. Index definitions

SET timezone = 'Asia/Shanghai';

`;

content = pgHeader + content;

// 16. 清理多余的空行
content = content.replace(/\n{3,}/g, '\n\n');

fs.writeFileSync(outputFile, content, 'utf8');

console.log('Conversion completed!');
console.log('\nImportant notes:');
console.log('1. Review the converted SQL file for any remaining MySQL-specific syntax');
console.log('2. Check AUTO_INCREMENT columns - you may need to use SERIAL or sequences');
console.log('3. Verify boolean values in INSERT statements');
console.log('4. Test the SQL file before importing to PostgreSQL');

